<th:block th:with="title='Автомобили для такси', active='cars'"
          th:replace="~{_fragments/layout :: layout(${title}, ${active}, ~{::content})}"
          xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
    <th:block th:fragment="content">

        <div class="card" th:if="${mode != null and mode != 'regular'}" style="margin-bottom: var(--space-md);">
            <span class="chip"
                  th:text="${mode == 'taxi' ? 'Спец-подборка для такси'
                                 : (mode == 'delivery' ? 'Спец-подборка для доставки' : mode)}">Режим</span>
            <p class="text-muted" style="margin-top: var(--space-sm);">Здесь показываются автомобили для выбранного направления.</p>
        </div>

        <h2 class="page-title">Каталог автомобилей для такси</h2>

        <form class="card form form--filters filters-v2" th:action="@{/cars/taxi}" method="get">
            <div class="filters-v2__bar">
                <button class="btn btn--sm" type="submit">Фильтр</button>
                <a class="btn btn--sm btn--light" th:href="@{/cars/taxi}">Сброс</a>
            </div>
            <div class="form__grid">
                <div>
                    <label>Марка/Модель</label>
                    <input type="text" name="q" placeholder="Например, Toyota" th:value="${q}">
                </div>
                <div>
                    <label>Класс</label>
                    <select name="vehicleClass" th:value="${vehicleClass}">
                        <option value="">Любой</option>
                        <option>Эконом</option><option>Комфорт</option><option>Бизнес</option>
                        <option>Паркетник</option><option>Внедорожник</option><option>Премиум</option>
                    </select>
                </div>
                <div>
                    <label>КПП</label>
                    <select name="transmission" th:value="${transmission}">
                        <option value="">Любая</option><option>AT</option><option>MT</option>
                    </select>
                </div>
                <div>
                    <label>Цена до, ₽/день</label>
                    <input type="number" name="maxPrice" step="100" th:value="${maxPrice}">
                </div>
                <div>
                    <label>Сортировка</label>
                    <select name="sort" th:value="${sort}">
                        <option th:value="${null}" th:selected="${sort==null}">Без сортировки</option>
                        <option value="price_asc"  th:selected="${sort=='price_asc'}">Цена ↑</option>
                        <option value="price_desc" th:selected="${sort=='price_desc'}">Цена ↓</option>
                        <option value="make"       th:selected="${sort=='make'}">Марка A→Z</option>
                        <option value="newest"     th:selected="${sort=='newest'}">Год (новые)</option>
                    </select>
                </div>
            </div>
            <div class="form__actions">
                <button class="btn" type="submit">Фильтровать</button>
                <a class="btn btn--light" th:href="@{/cars/taxi}">Сбросить</a>
            </div>
        </form>

        <div class="grid grid--3" th:if="${#lists.size(cars) > 0}">
            <article class="card car car--v2 card--hover" th:each="c : ${cars}">
                <div class="car__media">
                    <div class="img-skel shimmer">
                        <img
                                th:src="${c != null and c.photoUrl != null and !#strings.isEmpty(c.photoUrl) ?
                                ((c.photoUrl.startsWith('http') or c.photoUrl.startsWith('/'))
                                    ? c.photoUrl
                                    : '/images/' + c.photoUrl)
                               : '/images/placeholder-car.jpg'}"
                                alt="" loading="lazy"
                                onerror="this.onerror=null;this.src='/images/placeholder-car.jpg';">
                    </div>
                </div>

                <div class="car__head">
                    <h3 th:text="${c.make + ' ' + c.model}">Make Model</h3>
                    <span class="chip" th:text="${c.available} ? 'Доступен' : 'Недоступен'"
                          th:classappend="${c.available} ? ' chip--ok' : ' chip--warn'">Статус</span>
                </div>

                <p class="text-muted">
                    <span th:text="'Класс: ' + ${c.vehicleClass}">Class</span> •
                    <span th:text="'КПП: ' + ${c.transmission}">Transmission</span> •
                    <span th:text="'Год: ' + ${c.year}">Year</span>
                </p>

                <div class="car__price">
                    <div class="price"
                         th:text="${#numbers.formatDecimal(c.dailyPrice, 0, 'COMMA', 0, 'POINT')} + ' ₽/день'">0 ₽/день</div>

                    <div class="hero__actions" style="margin-top: var(--space-sm);">
                        <a class="btn btn--sm" th:href="@{/cars/{id}(id=${c.id})}">Подробнее</a>
                    </div>

                    <a class="btn" th:href="@{/booking(carId=${c.id})}" sec:authorize="isAuthenticated()">Забронировать</a>
                    <a class="btn btn--light" th:href="@{/login(from='booking')}" sec:authorize="isAnonymous()">Забронировать</a>
                </div>
            </article>
        </div>

        <div class="empty" th:if="${#lists.size(cars) == 0}">
            <p>Ничего не найдено. Измените фильтры.</p>
        </div>

    </th:block>
</th:block>
