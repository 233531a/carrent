<th:block th:with="title='Управление пользователями', active='admin'"
          th:replace="~{_fragments/layout :: layout(${title}, ${active}, ~{::content})}">
    <th:block th:fragment="content">

        <div class="page-head">
            <h2 class="mt-0">Управление пользователями</h2>
        </div>

        <!-- Search Form -->
        <form class="card form form--filters" method="get" th:action="@{/admin/users}" style="margin-bottom: var(--space-xl);">
            <div class="form__grid">
                <div>
                    <label>Поиск по логину</label>
                    <input type="text" name="q" placeholder="Введите логин для поиска" th:value="${q}">
                </div>
            </div>
            <div class="form__actions">
                <button class="btn" type="submit">Поиск</button>
                <a class="btn btn--light" th:href="@{/admin/users}">Сбросить</a>
            </div>
        </form>

        <!-- Alerts -->
        <div th:if="${param.updated}" class="alert">
            <strong>✓ Успешно:</strong> Роли пользователя обновлены (ID: <span th:text="${param.updated}"></span>)
        </div>
        <div th:if="${param.deleted}" class="alert">
            <strong>✓ Успешно:</strong> Пользователь удалён (ID: <span th:text="${param.deleted}"></span>)
        </div>
        <div th:if="${param.err}" class="alert alert--warn">
            <strong>⚠ Ошибка:</strong> Не удалось удалить пользователя. Возможно, есть связанные записи.
        </div>

        <!-- Users Grid -->
        <div class="grid grid--2" th:if="${#lists.size(users) > 0}">
            <div class="card" th:each="u : ${users}" style="display: flex; flex-direction: column; gap: var(--space-lg);">
                <!-- User Header -->
                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: var(--space-md); flex-wrap: wrap;">
                    <div>
                        <h3 class="mt-0" style="font-size: var(--font-size-xl);" th:text="${u.username}">Username</h3>
                        <p class="text-muted" style="margin: var(--space-xs) 0 0; font-size: var(--font-size-sm);">
                            ID: <span th:text="${u.id}"></span>
                        </p>
                    </div>
                    <div style="display: flex; gap: var(--space-sm); align-items: center;">
                        <span class="chip" th:classappend="${u.enabled} ? ' chip--ok' : ' chip--warn'"
                              th:text="${u.enabled} ? 'Активен' : 'Неактивен'">Активен</span>
                    </div>
                </div>

                <!-- Roles Form -->
                <div style="border-top: 1px solid var(--border); padding-top: var(--space-lg);">
                    <form th:action="@{|/admin/users/${u.id}/roles|}" method="post" style="margin: 0;">
                        <label style="display: block; margin-bottom: var(--space-md); font-weight: 600; color: var(--text-primary);">
                            Роли пользователя:
                        </label>
                        <div style="display: flex; flex-direction: column; gap: var(--space-sm); margin-bottom: var(--space-lg);">
                            <label th:each="r : ${allRoles}" 
                                   class="role-checkbox-label"
                                   style="display: flex; gap: var(--space-sm); align-items: center; padding: var(--space-sm); border-radius: var(--radius-md); cursor: pointer; transition: background var(--transition-base);">
                                <input type="checkbox" name="role"
                                       th:value="${r.name}"
                                       th:checked="${#lists.contains(u.roles, r)}"
                                       style="width: auto; margin: 0; cursor: pointer;">
                                <span style="flex: 1; cursor: pointer;" th:text="${r.name}">Role</span>
                            </label>
                        </div>
                        <div class="form__actions" style="margin: 0; padding: 0;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <button class="btn btn--sm" type="submit">Сохранить роли</button>
                        </div>
                    </form>
                </div>

                <!-- Delete Action -->
                <div style="border-top: 1px solid var(--border); padding-top: var(--space-lg);">
                    <form th:action="@{|/admin/users/${u.id}/delete|}" method="post"
                          onsubmit="return confirm('Вы уверены, что хотите удалить пользователя \'${u.username}\'? Это действие нельзя отменить.')"
                          style="margin: 0;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <button class="btn btn--danger btn--sm" type="submit" style="width: 100%;">Удалить пользователя</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div class="empty" th:if="${#lists.size(users) == 0}">
            <p>Пользователи не найдены.</p>
        </div>

    </th:block>
</th:block>