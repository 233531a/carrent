<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Заявки и аренды</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body th:replace="~{'_fragments/layout' :: layout('Заявки и аренды', 'manager', ~{::section})}">
<section class="container">

    <div th:if="${param.ok}" class="alert">Заявка одобрена (ID: <span th:text="${param.ok}"></span>)</div>
    <div th:if="${param.rejected}" class="alert alert--warn">Заявка отклонена (ID: <span th:text="${param.rejected}"></span>)</div>
    <div th:if="${param.completed}" class="alert">Аренда завершена (ID: <span th:text="${param.completed}"></span>)</div>

    <form class="card" method="get" th:action="@{/manager/rentals}">
        <div class="form__grid" style="grid-template-columns: 220px 1fr auto;">
            <div>
                <label>Статус</label>
                <select name="status" class="form-select">
                    <option value="ALL" th:selected="${status=='ALL'}">Все</option>
                    <option value="PENDING" th:selected="${status=='PENDING'}">Ожидание</option>
                    <option value="ACTIVE" th:selected="${status=='ACTIVE'}">Активна</option>
                    <option value="REJECTED" th:selected="${status=='REJECTED'}">Отклонена</option>
                    <option value="COMPLETED" th:selected="${status=='COMPLETED'}">Завершена</option>
                    <option value="CANCELLED" th:selected="${status=='CANCELLED'}">Отменена</option>
                </select>
            </div>
            <div>
                <label>Поиск</label>
                <input class="form-control" name="q" placeholder="Логин, авто, ID" th:value="${q}">
            </div>
            <div style="align-self:end;">
                <button class="btn btn--sm" type="submit">Применить</button>
            </div>
        </div>
    </form>

    <div class="table-wrap card">
        <table class="table table-striped table-hover align-middle">
            <thead>
            <tr>
                <th>ID</th>
                <th>Создано</th>
                <th>Клиент</th>
                <th>Авто</th>
                <th>Период</th>
                <th>Статус</th>
                <th style="width:260px;">Действия</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="r : ${rentals}">
                <td th:text="${r.id}">1</td>
                <td th:text="${#temporals.format(r.createdAt, 'dd.MM.yyyy HH:mm')}">01.01.2025</td>
                <td th:text="${r.customer != null && r.customer.user != null ? r.customer.user.username : '—'}">user</td>
                <td th:text="${r.car != null ? (r.car.make + ' ' + r.car.model) : '—'}">Марка Модель</td>
                <td>
                    <span th:text="${#temporals.format(r.startDate, 'dd.MM.yyyy')}"></span> —
                    <span th:text="${#temporals.format(r.endDate, 'dd.MM.yyyy')}"></span>
                </td>
                <td>
          <span class="badge"
                th:classappend="${
                   r.status.name()=='PENDING'   ? ' text-bg-warning'  :
                   r.status.name()=='ACTIVE'    ? ' text-bg-primary'  :
                   r.status.name()=='REJECTED'  ? ' text-bg-secondary':
                   r.status.name()=='COMPLETED' ? ' text-bg-success'  :
                                                  ' text-bg-light'}"
                th:text="${r.status.titleRu}">Ожидание</span>
                </td>
                <td>
                    <div th:if="${r.status.name() == 'PENDING'}" class="btn-group" role="group">
                        <form th:action="@{|/manager/rentals/${r.id}/approve|}" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <button class="btn btn--sm" type="submit">Одобрить</button>
                        </form>
                        <form th:action="@{|/manager/rentals/${r.id}/reject|}" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <button class="btn btn--sm btn--light" type="submit"
                                    onclick="return confirm('Отклонить заявку?');">Отклонить</button>
                        </form>
                    </div>

                    <div th:if="${r.status.name() == 'ACTIVE'}" class="btn-group">
                        <form th:action="@{|/manager/rentals/${r.id}/complete|}" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <button class="btn btn--sm btn--light" type="submit">Завершить</button>
                        </form>
                    </div>

                    <div th:if="${r.status.name() != 'PENDING' and r.status.name() != 'ACTIVE'}" class="text-muted">—</div>
                </td>
            </tr>
            <tr th:if="${#lists.isEmpty(rentals)}">
                <td colspan="7" class="text-center text-muted">Ничего не найдено</td>
            </tr>
            </tbody>
        </table>
    </div>

</section>
</body>
</html>