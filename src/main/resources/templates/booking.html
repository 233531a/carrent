<th:block th:with="title='–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ', active='booking'"
          th:replace="~{_fragments/layout :: layout(${title}, ${active}, ~{::content})}">
    <th:block th:fragment="content">
        <div class="card">
            <div style="margin-bottom: var(--space-xl);">
                <h2 class="page-title mt-0">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏</h2>
                <p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å –∏ —É–∫–∞–∂–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –∞—Ä–µ–Ω–¥—ã. –ú—ã –æ–±—Ä–∞–±–æ—Ç–∞–µ–º –∑–∞—è–≤–∫—É –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç.</p>
            </div>

            <p class="alert alert--warn" th:if="${dateError}" th:text="${dateError}">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞—Ç—ã</p>

            <form id="bookingForm" class="form" th:action="@{/booking}" method="post" novalidate>
                <div class="form__grid">
                    <div class="field">
                        <label>üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å</label>
                        <select id="carId" name="carId" class="form-select" required>
                            <option value="" disabled th:unless="${selectedCarId != null}" selected>–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å‚Ä¶</option>
                            <option th:each="c : ${cars}"
                                    th:value="${c.id}"
                                    th:selected="${selectedCarId != null} ? (c.id == selectedCarId) : false"
                                    th:attr="data-price=${c.dailyPrice}"
                                    th:text="${c.make + ' ' + c.model + ' ‚Ä¢ ' + c.year + ' ‚Ä¢ ' + #numbers.formatDecimal(c.dailyPrice, 0, 'COMMA', 0, 'POINT') + ' ‚ÇΩ/–¥–µ–Ω—å'}">
                                –ê–≤—Ç–æ
                            </option>
                        </select>
                        <small class="text-muted">–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Å—É—Ç–æ—á–Ω–∞—è ‚Äî –≤–æ–∑—å–º—ë–º –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞–≤—Ç–æ.</small>
                    </div>

                    <div class="field">
                        <label>üìÖ –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                        <input id="startDate" class="form-control" type="date" name="startDate" required>
                        <small class="text-muted">–ù–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º</small>
                    </div>

                    <div class="field">
                        <label>üìÖ –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                        <input id="endDate" class="form-control" type="date" name="endDate" required>
                        <small class="text-muted">–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –∏–ª–∏ —Ä–∞–≤–Ω–∞ –¥–∞—Ç–µ –Ω–∞—á–∞–ª–∞</small>
                    </div>
                </div>

                <!-- Summary Block -->
                <div class="card" style="margin-top: var(--space-xl); background: var(--bg-secondary); border: 2px solid var(--primary);">
                    <h3 style="margin-bottom: var(--space-lg); color: var(--text-primary);">üí∞ –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</h3>
                    <div class="grid grid--3" style="margin-bottom: var(--space-md);">
                        <div>
                            <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--space-xs);">–°—Ç–∞–≤–∫–∞ –∑–∞ –¥–µ–Ω—å</div>
                            <div style="font-size: var(--font-size-xl); font-weight: 700; color: var(--primary);" id="dailyPrice">‚Äî</div>
                        </div>
                        <div>
                            <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--space-xs);">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π</div>
                            <div style="font-size: var(--font-size-xl); font-weight: 700; color: var(--text-primary);" id="daysCount">0</div>
                        </div>
                        <div>
                            <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--space-xs);">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</div>
                            <div style="font-size: var(--font-size-2xl); font-weight: 800; color: var(--primary);" id="totalPrice">‚Äî</div>
                        </div>
                    </div>
                    <small class="text-muted">–ò—Ç–æ–≥ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ): (–∫–æ–Ω–µ—Ü ‚àí –Ω–∞—á–∞–ª–æ) + 1 –¥–µ–Ω—å.</small>
                </div>

                <div class="form__actions">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button class="btn" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
                    <a class="btn btn--light" th:href="@{/cars}">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥</a>
                </div>
            </form>
        </div>

        <script>
            (function(){
                const form = document.getElementById('bookingForm');
                const sel  = document.getElementById('carId');
                const s    = document.getElementById('startDate');
                const e    = document.getElementById('endDate');

                const elDaily = document.getElementById('dailyPrice');
                const elDays  = document.getElementById('daysCount');
                const elTotal = document.getElementById('totalPrice');

                const fmt = new Intl.NumberFormat('ru-RU');

                // min=today
                const today = new Date(); today.setHours(0,0,0,0);
                const toISO = d => d.toISOString().slice(0,10);
                s.min = e.min = toISO(today);

                function getDailyPrice(){
                    const opt = sel && sel.options[sel.selectedIndex];
                    if(!opt) return null;
                    const raw = opt.getAttribute('data-price');
                    if(raw == null || raw === '') return null;
                    const n = Number(raw);
                    return Number.isFinite(n) ? n : null;
                }

                function diffDaysInclusive(sd, ed){
                    const msPerDay = 24*60*60*1000;
                    const diff = Math.round((ed - sd)/msPerDay);
                    return diff + 1; // –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ
                }

                function showMsg(text){
                    let alert = form.querySelector('.alert.alert--warn.calc');
                    if(!alert) {
                        alert = document.createElement('p');
                        alert.className = 'alert alert--warn calc';
                        form.insertBefore(alert, form.firstElementChild.nextElementSibling);
                    }
                    alert.textContent = text;
                }
                function clearMsg(){
                    const a = form.querySelector('.alert.alert--warn.calc');
                    if(a) a.remove();
                }

                function recalc(){
                    clearMsg();

                    const dp = getDailyPrice();
                    const sd = s.value ? new Date(s.value) : null;
                    const ed = e.value ? new Date(e.value) : null;
                    if(sd) sd.setHours(0,0,0,0);
                    if(ed) ed.setHours(0,0,0,0);

                    // –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Å—Ç–∞–≤–∫—É
                    elDaily.textContent = (dp != null) ? (fmt.format(dp) + ' ‚ÇΩ/–¥–µ–Ω—å') : '‚Äî';

                    // –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç
                    if(sd && sd < today){ showMsg('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º.'); }
                    if(sd && ed && ed < sd){ showMsg('–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –∏–ª–∏ —Ä–∞–≤–Ω–∞ –¥–∞—Ç–µ –Ω–∞—á–∞–ª–∞.'); }

                    // –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –¥–Ω–∏/–∏—Ç–æ–≥–æ
                    if(dp != null && sd && ed && ed >= sd){
                        const days = diffDaysInclusive(sd, ed);
                        const total = dp * days;
                        elDays.textContent  = String(days);
                        elTotal.textContent = fmt.format(total) + ' ‚ÇΩ';
                    } else {
                        elDays.textContent  = '0';
                        elTotal.textContent = '‚Äî';
                    }
                }

                // —Å–≤—è–∑–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
                s.addEventListener('change', ()=>{
                    e.min = s.value || e.min;
                    recalc();
                });
                e.addEventListener('change', recalc);
                if(sel) sel.addEventListener('change', recalc);

                // —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ submit
                form.addEventListener('submit', (ev)=>{
                    clearMsg();
                    const dp = getDailyPrice();
                    if(!sel || !sel.value){ showMsg('–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å.'); ev.preventDefault(); return; }
                    const sd = s.value ? new Date(s.value) : null;
                    const ed = e.value ? new Date(e.value) : null;
                    if(!sd || !ed){ showMsg('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã.'); ev.preventDefault(); return; }
                    sd.setHours(0,0,0,0); ed.setHours(0,0,0,0);
                    if(sd < today){ showMsg('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º.'); ev.preventDefault(); return; }
                    if(ed < sd){ showMsg('–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –∏–ª–∏ —Ä–∞–≤–Ω–∞ –¥–∞—Ç–µ –Ω–∞—á–∞–ª–∞.'); ev.preventDefault(); return; }
                    if(dp == null){ showMsg('–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞–≤—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ç–∞–≤–∫–∞.'); ev.preventDefault(); return; }
                });

                // –Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç, –µ—Å–ª–∏ selectedCarId —É–∂–µ –≤—ã–±—Ä–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                recalc();
            })();
        </script>
    </th:block>
</th:block>
