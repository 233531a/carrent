<th:block th:with="title='–ê–≤—Ç–æ–º–æ–±–∏–ª–∏', active='cars'"
          th:replace="~{_fragments/layout :: layout(${title}, ${active}, ~{::content})}"
          xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
    <th:block th:fragment="content">

        <!-- Info banner for special modes -->
        <div class="card" th:if="${mode != null and mode != 'regular'}" style="margin-bottom: var(--space-lg); border-left: 4px solid var(--primary);">
            <div style="display: flex; align-items: center; gap: var(--space-md); flex-wrap: wrap;">
                <span class="chip" 
                      th:classappend="${mode == 'taxi' ? ' chip--ok' : ' chip--warn'}"
                      th:text="${mode == 'taxi' ? 'üöï –°–ø–µ—Ü-–ø–æ–¥–±–æ—Ä–∫–∞ –¥–ª—è —Ç–∞–∫—Å–∏'
                                 : (mode == 'delivery' ? 'üì¶ –°–ø–µ—Ü-–ø–æ–¥–±–æ—Ä–∫–∞ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏' : mode)}">
                    –†–µ–∂–∏–º
                </span>
                <p class="text-muted" style="margin: 0;">–ó–¥–µ—Å—å –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è.</p>
            </div>
        </div>

        <div class="page-head">
            <h2 class="page-title" style="margin: 0;">–ö–∞—Ç–∞–ª–æ–≥ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π</h2>
            <div class="head-actions">
                <span class="text-muted" th:if="${cars != null}">
                    –ù–∞–π–¥–µ–Ω–æ: <strong th:text="${#lists.size(cars)}">0</strong>
                </span>
            </div>
        </div>

        <!-- Filters: regular mode -->
        <form class="card form form--filters" th:action="@{/cars}" method="get"
              th:if="${mode == null or mode == 'regular'}" style="margin-bottom: var(--space-xl);">
            <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md);">
                <h3 style="margin: 0; font-size: var(--font-size-lg);">üîç –§–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</h3>
            </div>
            <div class="form__grid">
                <div class="field">
                    <label>–ú–∞—Ä–∫–∞/–ú–æ–¥–µ–ª—å</label>
                    <input type="text" name="q" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, Toyota" th:value="${q}">
                </div>
                <div class="field">
                    <label>–ö–ª–∞—Å—Å</label>
                    <select name="vehicleClass" th:value="${vehicleClass}">
                        <option value="">–õ—é–±–æ–π</option>
                        <option>–≠–∫–æ–Ω–æ–º</option><option>–ö–æ–º—Ñ–æ—Ä—Ç</option><option>–ë–∏–∑–Ω–µ—Å</option>
                        <option>–ü–∞—Ä–∫–µ—Ç–Ω–∏–∫</option><option>–í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫</option><option>–ü—Ä–µ–º–∏—É–º</option>
                    </select>
                </div>
                <div class="field">
                    <label>–ö–ü–ü</label>
                    <select name="transmission" th:value="${transmission}">
                        <option value="">–õ—é–±–∞—è</option><option>AT</option><option>MT</option>
                    </select>
                </div>
                <div class="field">
                    <label>–¶–µ–Ω–∞ –¥–æ, ‚ÇΩ/–¥–µ–Ω—å</label>
                    <input type="number" name="maxPrice" step="100" placeholder="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞" th:value="${maxPrice}">
                </div>
                <div class="field">
                    <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                    <select name="sort" th:value="${sort}">
                        <option th:value="${null}" th:selected="${sort==null}">–ë–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</option>
                        <option value="price_asc"  th:selected="${sort=='price_asc'}">–¶–µ–Ω–∞ ‚Üë</option>
                        <option value="price_desc" th:selected="${sort=='price_desc'}">–¶–µ–Ω–∞ ‚Üì</option>
                        <option value="make"       th:selected="${sort=='make'}">–ú–∞—Ä–∫–∞ A‚ÜíZ</option>
                        <option value="newest"     th:selected="${sort=='newest'}">–ì–æ–¥ (–Ω–æ–≤—ã–µ)</option>
                    </select>
                </div>
            </div>
            <div class="form__actions">
                <button class="btn" type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                <a class="btn btn--light" th:href="@{/cars}">–°–±—Ä–æ—Å–∏—Ç—å</a>
            </div>
        </form>

        <!-- Sort for special modes -->
        <form class="card form" method="get"
              th:if="${mode != null and mode != 'regular'}"
              th:action="@{${#httpServletRequest.requestURI}}"
              style="margin-bottom: var(--space-xl);">
            <div class="form__grid form__grid--single">
                <div class="field">
                    <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                    <select name="sort" th:value="${sort}" onchange="this.form.submit()">
                        <option th:value="${null}" th:selected="${sort==null}">–ë–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</option>
                        <option value="price_asc"  th:selected="${sort=='price_asc'}">–¶–µ–Ω–∞ ‚Üë</option>
                        <option value="price_desc" th:selected="${sort=='price_desc'}">–¶–µ–Ω–∞ ‚Üì</option>
                        <option value="make"       th:selected="${sort=='make'}">–ú–∞—Ä–∫–∞ A‚ÜíZ</option>
                        <option value="newest"     th:selected="${sort=='newest'}">–ì–æ–¥ (–Ω–æ–≤—ã–µ)</option>
                    </select>
                </div>
            </div>
        </form>

        <!-- Car Cards -->
        <div class="scroller" th:if="${#lists.size(cars) > 0}">
            <article class="car-card" th:each="c : ${cars}" data-reveal>
                <a class="car-card__media" th:href="@{/cars/{id}(id=${c.id})}">
                    <img
                        th:src="${c != null and c.photoUrl != null and !#strings.isEmpty(c.photoUrl) ?
                            ((c.photoUrl.startsWith('http') or c.photoUrl.startsWith('/'))
                                ? c.photoUrl
                                : '/images/' + c.photoUrl)
                           : '/images/placeholder-car.jpg'}"
                        th:alt="${c.make + ' ' + c.model}"
                        loading="lazy"
                        onerror="this.onerror=null;this.src='/images/placeholder-car.jpg';">
                </a>
                <div class="car-card__body">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-sm);">
                        <h3 class="car-card__title" th:text="${c.make + ' ' + c.model}">Make Model</h3>
                        <span class="chip" 
                              th:classappend="${c.available} ? ' chip--ok' : ' chip--warn'"
                              th:text="${c.available} ? '–î–æ—Å—Ç—É–ø–µ–Ω' : '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'">
                            –°—Ç–∞—Ç—É—Å
                        </span>
                    </div>
                    <div class="car-card__tags">
                        <span th:text="'–ö–ª–∞—Å—Å: ' + ${c.vehicleClass}">Class</span>
                        <span th:text="'–ö–ü–ü: ' + ${c.transmission}">Transmission</span>
                        <span th:text="'–ì–æ–¥: ' + ${c.year}">Year</span>
                    </div>
                    <div class="car-card__foot">
                        <div class="price" th:text="${#numbers.formatDecimal(c.dailyPrice, 0, 'COMMA', 0, 'POINT')} + ' ‚ÇΩ/–¥–µ–Ω—å'">
                            0 ‚ÇΩ/–¥–µ–Ω—å
                        </div>
                        <div style="display: flex; gap: var(--space-sm);">
                            <a class="btn btn--sm" th:href="@{/cars/{id}(id=${c.id})}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                            <a class="btn btn--sm" 
                               th:href="@{/booking(carId=${c.id})}" 
                               sec:authorize="isAuthenticated()"
                               th:if="${c.available}">
                                –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
                            </a>
                            <a class="btn btn--sm btn--light" 
                               th:href="@{/login(from='booking')}" 
                               sec:authorize="isAnonymous()">
                                –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
                            </a>
                        </div>
                    </div>
                </div>
            </article>
        </div>

        <div class="empty" th:if="${#lists.size(cars) == 0}">
            <div style="font-size: 4rem; margin-bottom: var(--space-md);">üöó</div>
            <p style="font-size: var(--font-size-lg); margin-bottom: var(--space-sm);">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
            <p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–ª–∏ <a th:href="@{/cars}">—Å–±—Ä–æ—Å–∏—Ç—å –∏—Ö</a>.</p>
        </div>

        <script>
            // Intersection Observer for reveal animations
            (function() {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('is-visible');
                        }
                    });
                }, { threshold: 0.1 });

                document.querySelectorAll('[data-reveal]').forEach(el => observer.observe(el));
            })();
        </script>
    </th:block>
</th:block>
